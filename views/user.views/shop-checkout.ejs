<%- include ('./layouts/head.ejs') %>

    <body>

        <%- include ('./partials/user.header.ejs') %>


            <main class="main">
                <div class="page-header breadcrumb-wrap">
                    <div class="container">
                        <div class="breadcrumb">
                            <a href="index.html" rel="nofollow">Home</a>
                            <span></span> Checkout
                        </div>
                    </div>
                </div>
                <section class="mt-50 mb-50">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-6 mb-sm-15">

                                <div class="table-responsive order_table text-center">
                                    <table class="table">

                                        <%if(typeof(userDefaultAddress)!== "undefined" ) {%>
                                            <%if(userDefaultAddress.length>0 ) {%>


                                                <thead>
                                                    <tr>
                                                        <th colspan="2">Delivery address</th>

                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>


                                                        <td>
                                                            <h5 style="margin-bottom: 5px;">
                                                                <%=userDefaultAddress[0].name %>
                                                            </h5>
                                                            <%=userDefaultAddress[0].houseName %>,
                                                                <%=userDefaultAddress[0].area %>
                                                                    <br>
                                                                    <%=userDefaultAddress[0].town %>,
                                                                        <%=userDefaultAddress[0].pincode %>
                                                                            <br>
                                                                            <%=userDefaultAddress[0].mobileNumber %>
                                                        </td>

                                                    </tr>

                                                </tbody>
                                                <%} %>
                                                    <%} %>

                                    </table>
                                </div>


                                <div class="toggle_info">
                                    <span><i class="fi-rs-user mr-10"></i><span style="margin-right: 10px;"
                                            class="text-muted">Change
                                            address </span> <a href="#changeAddress" data-bs-toggle="collapse"
                                            class="collapsed" aria-expanded="false"> Click here to select</a></span>
                                </div>
                                <div class="panel-collapse collapse login_form" id="changeAddress">
                                    <div class="panel-body">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th colspan="2">Saved addresses</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if(typeof(userAddresses)!=="undefined" ) {%>
                                                    <% userAddresses.forEach((address)=> { %>
                                                        <tr>

                                                            <td>
                                                                <input style="width: 20px; margin-right: 30px;"
                                                                    type="radio" name="addressSelection" id="address1"
                                                                    value="<%=address._id %>">
                                                                <label for="address1">
                                                                    <h5 style="margin-bottom: 5px; ">
                                                                        <%=address.name %>
                                                                    </h5>
                                                                    <%=address.houseName %>,
                                                                        <%=address.area %>
                                                                            <br>
                                                                            <%=address.town %>, <%=address.pincode %>
                                                                                    <br>
                                                                                    <%=address.mobileNumber %>
                                                                </label>
                                                            </td>

                                                        </tr>
                                                        <% })%>
                                                            <% }%>
                                                                <!-- Add more rows with similar structure for additional addresses -->
                                            </tbody>
                                        </table>

                                    </div>
                                </div>



                                <div class="toggle_info">
                                    <span><i class="fi-rs-user mr-10"></i><span style="margin-right: 10px;"
                                            class="text-muted">Deliver
                                            to a new address? </span> <a href="#loginform" data-bs-toggle="collapse"
                                            class="collapsed" aria-expanded="false"> Click here to add
                                            address</a></span>
                                </div>
                                <div class="panel-collapse collapse login_form" id="loginform">
                                    <div class="panel-body">

                                        <form method="post">
                                            <div class="form-group">
                                                <input type="text" name="name" placeholder="Name" id="name"
                                                    oninput="validateFieldName()">
                                                <span style="color: red;" id="nameError" class="error"></span>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="mobileNumber" placeholder="Mobile Number"
                                                    id="mobileNumber" oninput="validateFieldMobileNumber()">
                                                <span style="color: red;" id="mobileNumberError" class="error"></span>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="pincode" placeholder="Pincode" id="pincode"
                                                    oninput="validateFieldPincode()">
                                                <span style="color: red;" id="pincodeError" class="error"></span>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="houseName" placeholder="House name"
                                                    id="houseName" oninput="validateFieldHouseName()">
                                                <span style="color: red;" id="houseNameError" class="error"></span>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="area" placeholder="Area" id="area"
                                                    oninput="validateFieldarea()">
                                                <span style="color: red;" id="areaError" class="error"></span>

                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="landmark" placeholder="Land mark" id="landmark"
                                                    oninput="validateFieldlandmark()">
                                                <span style="color: red;" id="landmarkError" class="error"></span>

                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="town" placeholder="Town" id="town"
                                                    oninput="validateFieldtown()">
                                                <span style="color: red;" id="townError" class="error"></span>

                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="state" placeholder="State" id="state"
                                                    oninput="validateFieldstate()">
                                                <span style="color: red;" id="stateError" class="error"></span>
                                            </div>


                                            <div class="form-group">
                                                <button onclick="setDeliveryAddress()" type="button" class="btn btn-md"
                                                    name="login">Set Delivery Address</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>



                                <div class="col-lg-6" style="width: 540px; margin-top: 25px;">
                                    <div class="toggle_info">
                                        <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a
                                                coupon?</span> <a href="#coupon" data-bs-toggle="collapse"
                                                class="collapsed" aria-expanded="false">Click
                                                here to enter your
                                                code</a></span>
                                    </div>
                                    <div class="panel-collapse collapse coupon_form " id="coupon">
                                        <div class="panel-body">
                                            <p class="mb-30 font-sm">If you have a coupon code, please apply it below.
                                            </p>
                                            <form method="post">
                                                <div class="form-group">
                                                    <input type="text" placeholder="Enter Coupon Code...">
                                                </div>
                                                <div class="form-group">
                                                    <button class="btn  btn-md" name="login">Apply Coupon</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-5">
                                <div class="order_review">
                                    <div class="mb-20">
                                        <h4>Order Summary</h4>
                                    </div>
                                    <div class="table-responsive order_table text-center">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th colspan="2">Product</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                <%if(typeof(userCart) !=="undefined" ) {%>
                                                    <%userCart.forEach((user)=> {%>

                                                        <tr>
                                                            <td class="image product-thumbnail"><img
                                                                    src="<%=user.product[0].images[0].url %>" alt="#">
                                                            </td>
                                                            <input type="hidden" class="productId"
                                                                value="<%=user.product[0]._id %>">
                                                            <input type="hidden" class="productQuantity"
                                                                value="<%=user.cart.quantity %>">
                                                            <td>
                                                                <h5><a href="shop-product-full.html">
                                                                        <%=user.product[0].name %>
                                                                    </a>
                                                                </h5> <span class="product-qty">x <%=user.cart.quantity
                                                                        %></span>
                                                            </td>
                                                            <td class="sub-total-individual-products">
                                                                <%=user.subTotal %>
                                                            </td>
                                                        </tr>

                                                        <%}) %>
                                                            <%} %>


                                                <%if(typeof(product) !=="undefined" ) {%>
                                                    <%product.forEach((product)=> {%>

                                                        <tr>
                                                            <td class="image product-thumbnail"><img
                                                                    src="<%=product.images[0].url %>" alt="#">
                                                            </td>
                                                            <input type="hidden" class="productId"
                                                                value="<%=product._id %>">
                                                            <input type="hidden" class="productQuantity"
                                                                value="<%=productQuantity %>">
                                                            <td>
                                                                <h5><a href="shop-product-full.html">
                                                                        <%=product.name %>
                                                                    </a>
                                                                </h5> <span class="product-qty">x <%=productQuantity
                                                                        %></span>
                                                            </td>
                                                            <td class="sub-total-individual-products">
                                                                <%=subTotal %>
                                                            </td>
                                                        </tr>

                                                        <%}) %>
                                                            <%} %>


                                                                <tr>
                                                                    <th>SubTotal</th>
                                                                    <td class="product-subtotal" colspan="2"
                                                                        id="totalAmountBeforeShipping">$280.00</td>
                                                                </tr>
                                                                <tr>
                                                                    <th>Shipping</th>
                                                                    <td colspan="2"><em>Free Shipping</em></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>Total</th>
                                                                    <td colspan="2" class="product-subtotal"
                                                                        id="totalAmount"><span
                                                                            class="font-xl text-brand fw-900">$280.00</span>
                                                                    </td>
                                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                    <div class="payment_method">
                                        <div class="mb-25">
                                            <h5>Select a Payment method</h5>
                                        </div>
                                        <div class="payment_option">
                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="exampleRadios3" value="Cash on delivery" >
                                                <label class="form-check-label" for="exampleRadios3"
                                                    data-bs-toggle="collapse" data-target="#bankTranfer"
                                                    aria-controls="bankTranfer">Cash on delivery</label>
                                                <div class="form-group collapse in" id="bankTranfer">
                                                    
                                                </div>
                                            </div>
                                          <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="exampleRadios4" checked="">
                                                <label class="form-check-label" for="exampleRadios4"
                                                    data-bs-toggle="collapse" data-target="#checkPayment"
                                                    aria-controls="checkPayment">Check Payment</label>
                                                <div class="form-group collapse in" id="checkPayment">
                                                    
                                                </div>
                                            </div> 
                                            <div class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="exampleRadios5" checked="">
                                                <label class="form-check-label" for="exampleRadios5"
                                                    data-bs-toggle="collapse" data-target="#paypal"
                                                    aria-controls="paypal">Paypal</label>
                                                <div class="form-group collapse in" id="paypal">
                                                    
                                                </div>
                                            </div>
                                        </div> 
                                        </div>
                                        <a onclick="createOrder()" class="btn btn-fill-out btn-block mt-30 "
                                            style="margin-left: 100px;">Place Your Order</a>
                                    </div>
                                </div>

                            </div>

                            <div class="row">


                            </div>
                        </div>
                    </div>
                </section>
            </main>


            <script>

                function createOrder() {

                    // Calling the function to get product and quantity
                    getProductIdAndQuantity()
                    let productDetails = [];
    
                    // Making a single array from product and quantity array
                    productId.forEach((element, index) => {
                        let data = {
                            product: element,
                            quantity: quantity[index],
                        }
                        productDetails.push(data)
                    })

                    let data = {
                        selectedAddressIndex,
                        productDetails,
                        totalAmount,
                        paymentMethod
                    }
                    
                   data =  JSON.stringify(data)

                    fetch("/order/buy", {
                        method: "POST", headers: {
                            'Content-Type'
                                : 'application/json'
                        }, body: data,
                    }
                    )
                    .then((res) => {
                        return res.json()
                    })
                    .then((data) => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Order Placed Successfully!',
                            text: 'Thank you for choosing our service. Your order has been successfully placed.',
                        })
                        .then(() => {
                            window.location.href = "/order/view"
                        })
                    })

                   

                }

                // For getting the input address  
                let selectedAddressIndex;
                const radioButtons = document.querySelectorAll('input[name="addressSelection"]');

                radioButtons.forEach((radio) => {
                    radio.addEventListener('change', () => {
                        selectedAddressIndex = radio.value;
                    });
                });

                // For getting user selected payment method
                let paymentMethod;

                const paymentRadioButtons = document.querySelectorAll('input[name="payment_option"]');

                paymentRadioButtons.forEach((radio) => {
                    radio.addEventListener('change', () => {
                        paymentMethod = radio.value;
                    });
                });

                // For getting the productid and quantity
                let productId = [];
                let quantity = [];


                function getProductIdAndQuantity() {
                    let productIdElements = document.getElementsByClassName("productId")
                    let productQuantityElements = document.getElementsByClassName("productQuantity")

                    productIdElements = Array.from(productIdElements)
                    productQuantityElements = Array.from(productQuantityElements)

                    productIdElements.forEach((element) => {
                        productId.push(element.value)
                    })
                    productQuantityElements.forEach((element) => {
                        quantity.push(element.value)
                    })
                
                }




                // For calculating total amount

                document.addEventListener("DOMContentLoaded", loadTotalAmount)

                let totalAmount;
                function loadTotalAmount() {
                    let elements = document.getElementsByClassName("sub-total-individual-products")
                    elements = Array.from(elements)
    

                    totalAmount = elements.reduce((accumulator, value) => {
                        return parseInt(value.textContent) + accumulator;
                    }, 0)

                    let totalAmountBeforeShippingElement = document.getElementById("totalAmountBeforeShipping")
                    totalAmountBeforeShippingElement.textContent = '\u20B9 ' + totalAmount

                    let totalAmountElement = document.getElementById("totalAmount")
                    totalAmountElement.textContent = '\u20B9 ' + totalAmount
                    totalAmountElement.classList.add("text-brand")
                    totalAmountElement.classList.add("font-xl")
                    totalAmountElement.classList.add("fw-900")
                }


                function validateFieldName() {

                    const element = document.getElementById("name");
                    const nameErrorElement = document.getElementById("nameError");

                    if (element.value.length < 3 || element.value.length > 30 || !/^[A-Z]/.test(element.value)) {
                        nameErrorElement.innerHTML = "Name should be 3 to 30 characters and start with an uppercase letter";
                    } else {
                        nameErrorElement.innerHTML = "";
                    }
                }

                function validateFieldMobileNumber() {
                    const element = document.getElementById("mobileNumber");
                    const mobileNumberErrorElement = document.getElementById("mobileNumberError");

                    const mobileNumberValue = element.value;

                    if (mobileNumberValue.length !== 10) {
                        mobileNumberErrorElement.innerHTML = "Mobile number should be 10 digits";
                    } else if (!/^\d+$/.test(mobileNumberValue)) {
                        mobileNumberErrorElement.innerHTML = "Mobile number should consist only of digits";
                    } else {
                        mobileNumberErrorElement.innerHTML = "";
                    }
                }
                function validateFieldPincode() {
                    const element = document.getElementById("pincode");
                    const pincodeErrorElement = document.getElementById("pincodeError");

                    const pincodeValue = element.value;

                    if (element.value.length !== 6) {
                        pincodeErrorElement.innerHTML = "Pincode should be 6 digits";
                    } else if (!/^\d+$/.test(pincodeValue)) {
                        pincodeErrorElement.innerHTML = "Pincode should consist only of digits";
                    } else {
                        pincodeErrorElement.innerHTML = "";
                    }
                }


                function validateFieldHouseName() {
                    const houseNameElement = document.getElementById("houseName");
                    const houseNameErrorElement = document.getElementById("houseNameError");

                    if (houseNameElement.value.length < 3 || houseNameElement.value.length > 50) {
                        houseNameErrorElement.innerHTML = "HouseName should be 3 to 50 characters";
                    } else {
                        houseNameErrorElement.innerHTML = "";
                    }
                }
                function validateFieldarea() {
                    const areaElement = document.getElementById("area");
                    const areaErrorElement = document.getElementById("areaError");

                    if (areaElement.value.length < 3 || areaElement.value.length > 50) {
                        areaErrorElement.innerHTML = "Area name should be 3 to 50 characters";
                    } else {
                        areaErrorElement.innerHTML = "";
                    }
                }
                function validateFieldlandmark() {
                    const landmarkElement = document.getElementById("landmark");
                    const landmarkErrorElement = document.getElementById("landmarkError");

                    if (landmarkElement.value.length < 3 || landmarkElement.value.length > 50) {
                        landmarkErrorElement.innerHTML = "Landmark name should be 3 to 50 characters";
                    } else {
                        landmarkErrorElement.innerHTML = "";
                    }
                }
                function validateFieldtown() {
                    const townElement = document.getElementById("town");
                    const townErrorElement = document.getElementById("townError");

                    if (townElement.value.length < 3 || townElement.value.length > 50) {
                        townErrorElement.innerHTML = "Town name should be 3 to 50 characters";
                    } else {
                        townErrorElement.innerHTML = "";
                    }
                }
                function validateFieldstate() {
                    const stateElement = document.getElementById("state");
                    const stateErrorElement = document.getElementById("stateError");

                    if (stateElement.value.length < 3 || stateElement.value.length > 50) {
                        stateErrorElement.innerHTML = "State name should be 3 to 50 characters";
                    } else {
                        stateErrorElement.innerHTML = "";
                    }
                }

                function setDeliveryAddress() {
                    // Call individual validation functions
                    validateFieldName();
                    validateFieldMobileNumber();
                    validateFieldPincode()
                    validateFieldHouseName();
                    validateFieldarea();
                    validateFieldlandmark();
                    validateFieldtown();
                    validateFieldstate();

                    if (
                        nameError.innerHTML !== "" ||
                        mobileNumberError.innerHTML !== "" ||
                        pincodeError.innerHTML !== "" ||
                        houseNameError.innerHTML !== "" ||
                        areaError.innerHTML !== "" ||
                        landmarkError.innerHTML !== "" ||
                        townError.innerHTML !== "" ||
                        stateError.innerHTML !== ""


                    ) {
                        return false
                    }

                    let name = document.getElementById("name").value;
                    console.log(name);
                    let mobileNumber = document.getElementById("mobileNumber").value
                    let pincode = document.getElementById("pincode").value
                    let houseName = document.getElementById("houseName").value
                    let area = document.getElementById("area").value
                    let landmark = document.getElementById("landmark").value
                    let town = document.getElementById("town").value
                    let state = document.getElementById("state").value

                    let data = {
                        name,
                        mobileNumber,
                        pincode,
                        houseName,
                        area,
                        landmark,
                        town,
                        state,

                    }

                    data = JSON.stringify(data)

                    fetch("/order/address", {
                        method: "POST",
                        headers: {
                            'Content-Type'
                                : 'application/json'
                        },
                        body: data,
                    })
                        .then((res) => {
                            return res.json()
                        })
                        .then((data) => {
                            window.location.reload()
                        })
                }
            </script>

            <%- include ('./partials/user.footer.ejs') %>


                <!-- Vendor JS-->
                <script src="/user.assets/js/vendor/modernizr-3.6.0.min.js"></script>
                <script src="/user.assets/js/vendor/jquery-3.6.0.min.js"></script>
                <script src="/user.assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
                <script src="/user.assets/js/vendor/bootstrap.bundle.min.js"></script>
                <script src="/user.assets/js/plugins/slick.js"></script>
                <script src="/user.assets/js/plugins/jquery.syotimer.min.js"></script>
                <script src="/user.assets/js/plugins/wow.js"></script>
                <script src="/user.assets/js/plugins/jquery-ui.js"></script>
                <script src="/user.assets/js/plugins/perfect-scrollbar.js"></script>
                <script src="/user.assets/js/plugins/magnific-popup.js"></script>
                <script src="/user.assets/js/plugins/select2.min.js"></script>
                <script src="/user.assets/js/plugins/waypoints.js"></script>
                <script src="/user.assets/js/plugins/counterup.js"></script>
                <script src="/user.assets/js/plugins/jquery.countdown.min.js"></script>
                <script src="/user.assets/js/plugins/images-loaded.js"></script>
                <script src="/user.assets/js/plugins/isotope.js"></script>
                <script src="/user.assets/js/plugins/scrollup.js"></script>
                <script src="/user.assets/js/plugins/jquery.vticker-min.js"></script>
                <!-- Template  JS -->
                <script src="/user.assets/js/main.js?v=3.4"></script>
                <script src="/user.assets/js/shop.js?v=3.4"></script>

                <!--Sweet alert -->
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>
    </body>

    </html>